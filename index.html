<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wikipedia Loop Game</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        :root {
            --color-primary: #564756;
            --color-secondary: #507dba;
            --color-accent: #5acca0;
            --color-light: #e5f7d2;
        }
        
        body {
            font-family: 'Press Start 2P', monospace;
            margin: 0;
            padding: 0;
            background: var(--color-primary);
            display: flex;
            height: 100vh;
            color: var(--color-light);
        }
        
        .sidebar {
            width: 320px;
            background: var(--color-secondary);
            color: var(--color-light);
            padding: 20px;
            overflow-y: auto;
            position: relative;
        }
        
        .sidebar h2 {
            margin-top: 0;
            font-size: 14px;
            color: var(--color-accent);
            text-align: center;
            padding: 15px 0;
            border: 3px solid var(--color-accent);
            background: var(--color-primary);
            margin-bottom: 20px;
            position: relative;
        }
        
        .sidebar h3 {
            color: var(--color-accent);
            font-size: 12px;
            margin: 20px 0 10px 0;
        }
        
        .navigation-path {
            list-style: none;
            padding: 0;
            margin: 20px 0;
        }
        
        .navigation-path li {
            background: var(--color-primary);
            margin: 8px 0;
            padding: 12px;
            border-radius: 0;
            border-left: 4px solid var(--color-accent);
            font-size: 14px;
            transition: background 0.2s;
            color: var(--color-light);
        }
        
        .navigation-path li:hover {
            background: var(--color-secondary);
            cursor: pointer;
        }
        
        .navigation-path li.current {
            background: var(--color-accent);
            border-left-color: var(--color-accent);
            color: var(--color-primary);
        }
        
        .navigation-path li .step-number {
            font-weight: bold;
            color: var(--color-light);
            margin-right: 8px;
        }
        
        .button-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .score-box {
            background: var(--color-primary);
            padding: 15px;
            border: 3px solid var(--color-accent);
            margin-bottom: 12px;
        }
        
        .level-box {
            background: var(--color-primary);
            padding: 15px;
            border: 3px solid var(--color-accent);
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .target-box {
            background: var(--color-primary);
            padding: 15px;
            border: 3px solid var(--color-accent);
            margin-bottom: 20px;
        }
        
        /* Colon-aligned layout for info boxes */
        .score-box > div,
        .level-box > div,
        .target-box > div {
            display: flex;
            align-items: center;
        }
        
        .score-box .label,
        .target-box .label {
            min-width: 85px;
            text-align: left;
        }
        
        .level-box .label {
            min-width: 45px;
            text-align: left;
        }
        
        .colon {
            margin: 0 8px;
            color: var(--color-accent);
        }
        
        .value {
            font-weight: bold;
        }
        
        .unit {
            margin-left: 5px;
            font-size: 9px;
        }
        
        .global-score {
            font-size: 12px;
            font-weight: bold;
            color: var(--color-accent);
            margin-bottom: 8px;
        }
        
        .level-score {
            font-size: 10px;
            color: var(--color-light);
        }
        
        .level-display {
            color: var(--color-light);
            font-size: 10px;
        }
        
        .steps-display {
            color: var(--color-accent);
            font-size: 10px;
        }
        
        .target-steps {
            color: var(--color-accent);
            font-size: 10px;
            margin-bottom: 8px;
        }
        
        .target-article {
            color: var(--color-accent);
            font-weight: bold;
            font-size: 10px;
        }
        
        .game-btn {
            background: var(--color-accent);
            color: var(--color-primary);
            border: 3px solid var(--color-primary);
            padding: 8px 12px;
            cursor: pointer;
            font-size: 9px;
            font-family: 'Press Start 2P', monospace;
            position: relative;
            transition: all 0.1s;
            flex: 1;
            min-width: 80px;
        }
        
        .game-btn:hover {
            background: var(--color-light);
            color: var(--color-primary);
        }
        
        .game-btn:active {
            background: var(--color-secondary);
            color: var(--color-light);
        }
        
        .help-btn {
            background: var(--color-light);
            color: var(--color-primary);
        }
        
        .help-btn:hover {
            background: var(--color-accent);
            color: var(--color-primary);
        }
        
        .help-btn:active {
            background: var(--color-secondary);
            color: var(--color-light);
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background: var(--color-primary);
            margin: 5% auto;
            padding: 0;
            border: 6px solid var(--color-accent);
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            font-family: 'Press Start 2P', monospace;
        }
        
        .modal-header {
            background: var(--color-secondary);
            color: var(--color-accent);
            padding: 20px;
            text-align: center;
            border-bottom: 4px solid var(--color-accent);
            position: relative;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 20px;
            font-family: 'Press Start 2P', monospace;
            color: var(--color-accent);
        }
        
        .close {
            color: var(--color-accent);
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .close:hover {
            color: var(--color-light);
        }
        
        .modal-body {
            padding: 25px;
            color: var(--color-light);
            line-height: 1.6;
            font-size: 14px;
        }
        
        .help-section {
            margin-bottom: 25px;
            padding: 20px;
            background: var(--color-secondary);
            border: 2px solid var(--color-accent);
            border-left: 6px solid var(--color-accent);
        }
        
        .help-section h3 {
            color: var(--color-accent);
            margin: 0 0 15px 0;
            font-size: 16px;
            font-family: 'Press Start 2P', monospace;
        }
        
        .help-section p {
            margin: 12px 0;
            font-size: 13px;
            line-height: 1.6;
        }
        
        .help-section ul {
            margin: 15px 0;
            padding-left: 25px;
        }
        
        .help-section li {
            margin: 8px 0;
            font-size: 13px;
            line-height: 1.5;
        }
        
        .example {
            background: var(--color-primary);
            border-left-color: var(--color-accent);
        }
        
        .scoring {
            background: var(--color-primary);
            border-left-color: var(--color-accent);
        }
        
        .tips {
            background: var(--color-primary);
            border-left-color: var(--color-accent);
        }
        
        .pixel-arrow {
            color: var(--color-accent);
            font-weight: bold;
        }
        
        .game-result {
            background: var(--color-accent);
            color: var(--color-primary);
            padding: 15px;
            border: 3px solid var(--color-primary);
            margin-top: 20px;
            text-align: center;
            font-size: 8px;
        }
        
        .game-result.failure {
            background: var(--color-light);
            color: var(--color-primary);
        }
        
        .game-result.hidden {
            display: none;
        }
        
        .main-content {
            flex: 1;
            padding: 20px;
            overflow: hidden;
            background: var(--color-secondary);
            display: flex;
            flex-direction: column;
        }
        
        .wiki-container {
            flex: 1;
            max-width: none;
            margin: 0;
            background: #fff;
            padding: 0;
            border: 4px solid #000;
            box-shadow: 8px 8px 0 #333;
            position: relative;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .wiki-container::before {
            content: '';
            position: absolute;
            top: -8px;
            left: -8px;
            right: -8px;
            bottom: -8px;
            background: var(--color-accent);
            z-index: -1;
        }
        
        .wiki-title {
            font-size: 2.5em;
            margin: 20px 30px 20px 30px;
            border-bottom: 3px solid #a2a9b1;
            padding-bottom: 10px;
            color: #2c3e50;
            background: #fff;
            flex-shrink: 0;
        }
        
        .wiki-content {
            line-height: 1.6;
            font-size: 16px;
            color: #2c3e50;
        }
        
        .wiki-content a {
            color: #0645ad;
            text-decoration: none;
        }
        
        .wiki-content a:hover {
            text-decoration: underline;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: #666;
        }
        
        .error {
            background: #fee;
            border: 1px solid #fcc;
            padding: 20px;
            border-radius: 4px;
            color: #c33;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>Wikipedia Loop Game</h2>
        
        <div class="button-container">
            <button id="new-game-btn" class="game-btn">New Game</button>
            <button id="reset-level-btn" class="game-btn">Reset Level</button>
            <button id="help-btn" class="game-btn help-btn">Help</button>
        </div>
        
        <div class="score-box">
            <div class="global-score">
                <span class="label">Total Score</span>
                <span class="colon">:</span>
                <span class="value" id="global-score">0</span>
            </div>
            <div class="level-score">
                <span class="label">Level Score</span>
                <span class="colon">:</span>
                <span class="value" id="level-score">100</span>
            </div>
        </div>
        
        <div class="level-box">
            <div class="level-display">
                <span class="label">Level</span>
                <span class="colon">:</span>
                <span class="value" id="current-level">1</span>
            </div>
            <div class="steps-display">
                <span class="label">Steps</span>
                <span class="colon">:</span>
                <span class="value" id="steps-taken">0</span>
            </div>
        </div>
        
        <div class="target-box">
            <div class="target-steps">
                <span class="label">Target</span>
                <span class="colon">:</span>
                <span class="value" id="target-steps">2</span>
                <span class="unit">steps</span>
            </div>
            <div class="target-article">
                <span class="label">Return to</span>
                <span class="colon">:</span>
                <span class="value" id="target-article">-</span>
            </div>
        </div>
        
        <h3>Navigation Path</h3>
        <ul id="navigation-path" class="navigation-path">
            <!-- Navigation steps will be added here -->
        </ul>
        
        <div id="game-result" class="game-result hidden">
            <!-- Game result messages will appear here -->
        </div>
    </div>
    
    <div class="main-content">
        <div class="wiki-container">
            <div id="wiki-content" class="loading">Loading Wikipedia...</div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" id="close-modal">&times;</span>
                <h2>Game Instructions</h2>
            </div>
            <div class="modal-body">
                <div class="help-section">
                    <h3>OBJECTIVE</h3>
                    <p>Create loops by navigating through Wikipedia articles and returning to your starting article in exactly the target number of steps!</p>
                </div>
                
                <div class="help-section example">
                    <h3>HOW TO PLAY</h3>
                    <p><span class="pixel-arrow">></span> Level 1: Start at Article A <span class="pixel-arrow">></span> Go to Article B <span class="pixel-arrow">></span> Return to Article A (2 steps)</p>
                    <p><span class="pixel-arrow">></span> Level 2: A <span class="pixel-arrow">></span> B <span class="pixel-arrow">></span> C <span class="pixel-arrow">></span> D <span class="pixel-arrow">></span> A (4 steps)</p>
                    <p><span class="pixel-arrow">></span> Level N: Complete loop in exactly N×2 steps</p>
                    <ul>
                        <li>Click on blue Wikipedia links to navigate</li>
                        <li>External links are disabled (grayed out)</li>
                        <li>Must return to starting article in exact steps</li>
                    </ul>
                </div>
                
                <div class="help-section scoring">
                    <h3>SCORING SYSTEM</h3>
                    <p><span class="pixel-arrow">></span> Each level starts with 100 points</p>
                    <p><span class="pixel-arrow">></span> Perfect completion: Earn all points!</p>
                    <p><span class="pixel-arrow">></span> Going back: -10 points per step backward</p>
                    <p><span class="pixel-arrow">></span> Too many steps: No points (try again!)</p>
                    <p><span class="pixel-arrow">></span> Global score accumulates across levels</p>
                </div>
                
                <div class="help-section tips">
                    <h3>PRO TIPS</h3>
                    <ul>
                        <li>Check infoboxes (side panels) for related articles</li>
                        <li>Look for "See also" sections at article bottom</li>
                        <li>Geography/History articles have many connections</li>
                        <li>Countries link to capitals, continents, languages</li>
                        <li>People articles link to birth places, professions</li>
                        <li>Science topics connect through broader categories</li>
                        <li>Plan your route before clicking!</li>
                        <li>Popular articles = more incoming links</li>
                    </ul>
                </div>
                
                <div class="help-section">
                    <h3>CONTROLS</h3>
                    <p><span class="pixel-arrow">></span> New Game: Start over from Level 1</p>
                    <p><span class="pixel-arrow">></span> Reset Level: Retry current level</p>
                    <p><span class="pixel-arrow">></span> Help: Show these instructions</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let currentArticle = '';
        let navigationPath = [];
        let gameState = {
            level: 1,
            targetSteps: 2,
            startingArticle: '',
            gameStarted: false,
            gameCompleted: false,
            globalScore: 0,
            currentLevelScore: 100,
            backtrackPenalty: 10
        };
        
        // Cache management
        const CACHE_KEY = 'wikipedia-loop-game-cache';
        const CACHE_VERSION = '1.0';
        const MAX_CACHE_SIZE = 50; // Maximum number of articles to cache
        let articleCache = new Map();
        let preloadingArticles = new Set(); // Track articles currently being preloaded
        
        // Initialize cache from localStorage
        function initializeCache() {
            try {
                const cachedData = localStorage.getItem(CACHE_KEY);
                if (cachedData) {
                    const parsed = JSON.parse(cachedData);
                    if (parsed.version === CACHE_VERSION) {
                        articleCache = new Map(parsed.articles);
                        console.log(`Loaded ${articleCache.size} articles from cache`);
                    } else {
                        console.log('Cache version mismatch, clearing cache');
                        localStorage.removeItem(CACHE_KEY);
                    }
                }
            } catch (error) {
                console.error('Error loading cache:', error);
                localStorage.removeItem(CACHE_KEY);
            }
        }
        
        // Save cache to localStorage
        function saveCache() {
            try {
                const cacheData = {
                    version: CACHE_VERSION,
                    articles: Array.from(articleCache.entries()),
                    timestamp: Date.now()
                };
                localStorage.setItem(CACHE_KEY, JSON.stringify(cacheData));
            } catch (error) {
                console.error('Error saving cache:', error);
                // If storage is full, clear some old entries
                if (error.name === 'QuotaExceededError') {
                    clearOldCacheEntries();
                }
            }
        }
        
        // Clear old cache entries when storage is full
        function clearOldCacheEntries() {
            const entries = Array.from(articleCache.entries());
            // Sort by last accessed time and remove oldest half
            entries.sort((a, b) => (a[1].lastAccessed || 0) - (b[1].lastAccessed || 0));
            const toRemove = Math.floor(entries.length / 2);
            
            for (let i = 0; i < toRemove; i++) {
                articleCache.delete(entries[i][0]);
            }
            
            console.log(`Cleared ${toRemove} old cache entries`);
            saveCache();
        }
        
        // Add article to cache
        function addToCache(title, html, resolvedTitle = null) {
            // Remove oldest entries if cache is too large
            if (articleCache.size >= MAX_CACHE_SIZE) {
                const oldestKey = articleCache.keys().next().value;
                articleCache.delete(oldestKey);
            }
            
            const cacheData = {
                html: html,
                timestamp: Date.now(),
                lastAccessed: Date.now(),
                resolvedTitle: resolvedTitle || title
            };
            
            articleCache.set(title, cacheData);
            
            // Also cache under resolved title if different
            if (resolvedTitle && resolvedTitle !== title) {
                articleCache.set(resolvedTitle, cacheData);
            }
            
            saveCache();
        }
        
        // Get article from cache
        function getFromCache(title) {
            const cached = articleCache.get(title);
            if (cached) {
                // Update last accessed time
                cached.lastAccessed = Date.now();
                console.log(`Cache hit for: ${title}${cached.resolvedTitle && cached.resolvedTitle !== title ? ` (resolves to: ${cached.resolvedTitle})` : ''}`);
                return {
                    html: cached.html,
                    resolvedTitle: cached.resolvedTitle || title
                };
            }
            console.log(`Cache miss for: ${title}`);
            return null;
        }
        
        // Preload article in background
        async function preloadArticle(title) {
            // Don't preload if already cached or currently preloading
            if (articleCache.has(title) || preloadingArticles.has(title)) {
                return;
            }
            
            preloadingArticles.add(title);
            console.log(`Preloading article: ${title}`);
            
            try {
                const response = await fetch(`https://en.wikipedia.org/w/rest.php/v1/page/${encodeURIComponent(title)}/html`);
                if (response.ok) {
                    const html = await response.text();
                    addToCache(title, html);
                    console.log(`Preloaded and cached: ${title}`);
                }
            } catch (error) {
                console.error(`Error preloading ${title}:`, error);
            } finally {
                preloadingArticles.delete(title);
            }
        }
        
        // List of starting articles for the game
        const startingArticles = [
            'History',
            'Science',
            'Mathematics',
            'Geography',
            'Philosophy',
            'Technology',
            'Music',
            'Art',
            'Literature',
            'Biology',
            'Physics',
            'Chemistry',
            'Astronomy',
            'Computer',
            'Language',
            'Culture',
            'Religion',
            'Economy',
            'Politics',
            'Education'
        ];
        
        // Initialize game
        function initializeGame() {
            gameState.level = 1;
            gameState.targetSteps = 2;
            gameState.gameStarted = false;
            gameState.gameCompleted = false;
            gameState.globalScore = 0;
            gameState.currentLevelScore = 100;
            navigationPath = [];
            
            // Choose random starting article
            const randomIndex = Math.floor(Math.random() * startingArticles.length);
            gameState.startingArticle = startingArticles[randomIndex];
            // gameState.startingArticle = 'Technology'; // For testing purposes, use a fixed article
            
            updateGameDisplay();
            fetchWikipediaArticle(gameState.startingArticle, true);
        }
        
        // Update game display elements
        function updateGameDisplay() {
            document.getElementById('current-level').textContent = gameState.level;
            document.getElementById('target-steps').textContent = gameState.targetSteps;
            document.getElementById('steps-taken').textContent = navigationPath.length > 0 ? navigationPath.length - 1 : 0;
            document.getElementById('target-article').textContent = gameState.startingArticle;
            document.getElementById('global-score').textContent = gameState.globalScore;
            document.getElementById('level-score').textContent = gameState.currentLevelScore;
            
            // Hide game result
            document.getElementById('game-result').classList.add('hidden');
        }
        
        // Check if player has completed the level
        function checkGameCompletion() {
            if (!gameState.gameStarted || gameState.gameCompleted) return;
            
            const steps = navigationPath.length - 1; // Don't count starting article
            
            // Check if player returned to starting article
            if (currentArticle === gameState.startingArticle && steps > 0) {
                if (steps === gameState.targetSteps) {
                    // Perfect completion!
                    gameState.gameCompleted = true;
                    gameState.globalScore += gameState.currentLevelScore;
                    showGameResult(true, `Perfect! You completed level ${gameState.level} in exactly ${steps} steps! (+${gameState.currentLevelScore} points)`);
                    setTimeout(() => {
                        nextLevel();
                    }, 3000);
                } else if (steps > gameState.targetSteps) {
                    // Completed but with extra steps
                    gameState.gameCompleted = true;
                    showGameResult(false, `You returned to ${gameState.startingArticle} but took ${steps} steps instead of ${gameState.targetSteps}. Try again!`);
                }
            } else if (steps >= gameState.targetSteps * 2) {
                // Too many steps without returning
                gameState.gameCompleted = true;
                showGameResult(false, `Too many steps! Try to return to ${gameState.startingArticle} in ${gameState.targetSteps} steps.`);
            }
        }
        
        // Show game result
        function showGameResult(success, message) {
            const resultDiv = document.getElementById('game-result');
            resultDiv.textContent = message;
            resultDiv.classList.remove('hidden');
            if (success) {
                resultDiv.classList.remove('failure');
            } else {
                resultDiv.classList.add('failure');
            }
        }
        
        // Show temporary message (for penalties, bonuses, etc.)
        function showTemporaryMessage(message, type = 'info', duration = 2000) {
            const resultDiv = document.getElementById('game-result');
            const originalContent = resultDiv.textContent;
            const wasHidden = resultDiv.classList.contains('hidden');
            
            resultDiv.textContent = message;
            resultDiv.classList.remove('hidden');
            
            if (type === 'penalty') {
                resultDiv.classList.add('failure');
            } else {
                resultDiv.classList.remove('failure');
            }
            
            setTimeout(() => {
                if (wasHidden) {
                    resultDiv.classList.add('hidden');
                } else {
                    resultDiv.textContent = originalContent;
                }
            }, duration);
        }
        
        // Move to next level
        function nextLevel() {
            gameState.level++;
            gameState.targetSteps = gameState.level * 2;
            gameState.gameCompleted = false;
            gameState.gameStarted = false;
            gameState.currentLevelScore = 100; // Reset level score for new level
            navigationPath = [];
            
            // Choose new starting article
            const randomIndex = Math.floor(Math.random() * startingArticles.length);
            gameState.startingArticle = startingArticles[randomIndex];
            
            updateGameDisplay();
            fetchWikipediaArticle(gameState.startingArticle, true);
        }
        
        // Reset current level
        function resetLevel() {
            gameState.gameCompleted = false;
            gameState.gameStarted = false;
            gameState.currentLevelScore = 100; // Reset level score when resetting level
            navigationPath = [];
            updateGameDisplay();
            fetchWikipediaArticle(gameState.startingArticle, true);
        }
        
        // Add event listeners for game buttons
        document.getElementById('new-game-btn').addEventListener('click', initializeGame);
        document.getElementById('reset-level-btn').addEventListener('click', resetLevel);
        
        // Help modal functionality
        const helpModal = document.getElementById('help-modal');
        const helpBtn = document.getElementById('help-btn');
        const closeModal = document.getElementById('close-modal');
        
        helpBtn.addEventListener('click', () => {
            helpModal.style.display = 'block';
        });
        
        closeModal.addEventListener('click', () => {
            helpModal.style.display = 'none';
        });
        
        // Close modal when clicking outside of it
        window.addEventListener('click', (event) => {
            if (event.target === helpModal) {
                helpModal.style.display = 'none';
            }
        });
        
        // Close modal with Escape key
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && helpModal.style.display === 'block') {
                helpModal.style.display = 'none';
            }
        });
        
        // Add article to navigation path
        function addToNavigationPath(articleTitle) {
            // Don't add the same article consecutively
            if (navigationPath.length > 0 && navigationPath[navigationPath.length - 1] === articleTitle) {
                console.log('Skipping duplicate consecutive article:', articleTitle);
                return;
            }
            
            navigationPath.push(articleTitle);
            updateNavigationDisplay();
            updateGameDisplay();
            
            // Mark game as started after first move
            if (navigationPath.length > 1) {
                gameState.gameStarted = true;
            }
            
            // Check for game completion
            checkGameCompletion();
        }
        
        // Update the navigation path display in sidebar
        function updateNavigationDisplay() {
            const pathContainer = document.getElementById('navigation-path');
            pathContainer.innerHTML = '';
            
            navigationPath.forEach((article, index) => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span class="step-number">${index + 1}.</span>
                    ${article}
                `;
                
                // Mark current article
                if (index === navigationPath.length - 1) {
                    li.classList.add('current');
                }
                
                // Add click handler to navigate back to previous articles
                li.addEventListener('click', async () => {
                    // Allow clicking on any article
                    if (index !== navigationPath.length - 1) {
                        // Apply penalty for backtracking if game has started
                        if (gameState.gameStarted && !gameState.gameCompleted) {
                            const stepsBack = navigationPath.length - 1 - index;
                            const penalty = stepsBack * gameState.backtrackPenalty;
                            gameState.currentLevelScore = Math.max(0, gameState.currentLevelScore - penalty);
                            updateGameDisplay();
                            
                            // Show penalty message briefly
                            showTemporaryMessage(`-${penalty} points for going back ${stepsBack} step(s)`, 'penalty');
                        }
                        
                        // Only trim path and navigate if it's not the current article
                        navigationPath = navigationPath.slice(0, index + 1);
                        currentArticle = article;
                        await fetchWikipediaArticle(article, false); // false = don't add to path
                    }
                });
                
                pathContainer.appendChild(li);
            });
        }
        
        // Fetch Wikipedia article content
        async function fetchWikipediaArticle(title, addToPath = true) {
            try {
                console.log('Fetching article:', title);
                
                // Check cache first
                let cacheResult = getFromCache(title);
                let html = cacheResult ? cacheResult.html : null;
                let resolvedTitle = cacheResult ? cacheResult.resolvedTitle : title;
                
                if (!html) {
                    // Not in cache, fetch from API
                    const response = await fetch(`https://en.wikipedia.org/w/rest.php/v1/page/${encodeURIComponent(title)}/html`);
                    if (!response.ok) {
                        // Show alert for missing articles instead of navigating
                        if (response.status === 404) {
                            alert(`Article "${title}" not found. Try clicking on a different link.`);
                            return;
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    html = await response.text();
                    
                    // Extract the actual resolved title from the response headers or HTML
                    const finalUrl = response.url;
                    if (finalUrl && finalUrl.includes('/page/')) {
                        // Extract title from the final URL after redirects
                        const urlParts = finalUrl.split('/page/');
                        if (urlParts.length > 1) {
                            resolvedTitle = decodeURIComponent(urlParts[1].split('/')[0]).replace(/_/g, ' ');
                        }
                    }
                    
                    // Also try to extract title from HTML content
                    const titleMatch = html.match(/<title[^>]*>([^<]+)<\/title>/i);
                    if (titleMatch && titleMatch[1]) {
                        const htmlTitle = titleMatch[1].replace(/ - Wikipedia$/, '').trim();
                        if (htmlTitle && htmlTitle !== 'Wikipedia') {
                            resolvedTitle = htmlTitle;
                        }
                    }

                    console.log('Article fetched from API:', title, '-> resolved to:', resolvedTitle);

                    // Add to cache with resolved title
                    addToCache(title, html, resolvedTitle);
                    console.log('Article fetched from API and cached');
                } else {
                    console.log('Article loaded from cache');
                }
                
                displayArticle(resolvedTitle, html);
                currentArticle = resolvedTitle; // Use resolved title as current article
                
                // Add to navigation path if this is a new navigation
                if (addToPath) {
                    addToNavigationPath(resolvedTitle); // Use resolved title in navigation
                } else {
                    // If not adding to path (navigating back), still update the display
                    updateNavigationDisplay();
                }
            } catch (error) {
                console.error('Error fetching article:', error);
                // Show alert instead of replacing content with error message
                alert(`Failed to load article "${title}". Please try again or click on a different link.`);
            }
        }
        
        // Display article content using iframe for complete isolation
        function displayArticle(title, html) {
            const container = document.getElementById('wiki-content');
            
            // Clear previous content and remove loading class
            container.innerHTML = '';
            container.className = '';
            container.style.cssText = 'display: flex; flex-direction: column; flex: 1; overflow: hidden;';
            
            // Create title outside iframe
            const titleElement = document.createElement('h1');
            titleElement.className = 'wiki-title';
            titleElement.textContent = title;
            container.appendChild(titleElement);
            
            // Create iframe for Wikipedia content
            const iframe = document.createElement('iframe');
            iframe.style.cssText = 'width: 100%; flex: 1; border: none; background: white;';
            iframe.sandbox = 'allow-same-origin allow-scripts';
            container.appendChild(iframe);
            
            // Write the Wikipedia HTML directly to the iframe
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            iframeDoc.open();
            iframeDoc.write(html);
            iframeDoc.close();
            
            // Scroll to top of the main content area
            const mainContent = document.querySelector('.main-content');
            mainContent.scrollTop = 0;
            
            // Wait for iframe to load then process links
            iframe.onload = () => {
                // Convert Wikipedia links to custom clickable spans within iframe
                const links = iframeDoc.querySelectorAll('a');
                console.log('Found links:', links.length);
                
                links.forEach((link, index) => {
                    const href = link.getAttribute('href');
                    const rel = link.getAttribute('rel');
                    const title = link.getAttribute('title');
                    
                    // Check if it's a Wikipedia link
                    if ((rel && rel.includes('mw:WikiLink')) || 
                        (href && (
                            href.startsWith('/wiki/') || 
                            href.includes('wikipedia.org/wiki/') ||
                            href.includes('en.wikipedia.org/wiki/')
                        ))) {
                        
                        // Extract article title from different sources
                        let articleTitle = '';
                        
                        if (href && href.startsWith('/wiki/')) {
                            articleTitle = href.replace('/wiki/', '');
                        } else if (href && href.includes('/wiki/')) {
                            articleTitle = href.split('/wiki/')[1];
                        } else if (title) {
                            articleTitle = title;
                        } else if (rel && rel.includes('mw:WikiLink')) {
                            articleTitle = link.textContent.trim();
                        }
                        
                        // Clean up the title
                        articleTitle = decodeURIComponent(articleTitle)
                            .replace(/_/g, ' ')
                            .split('#')[0];
                        
                        // Create a custom clickable span
                        const span = iframeDoc.createElement('span');
                        span.innerHTML = link.innerHTML;
                        span.className = 'wiki-link';
                        span.style.cssText = 'color: #0645ad; cursor: pointer; text-decoration: none;';
                        span.title = `Navigate to: ${articleTitle}`;
                        span.dataset.articleTitle = articleTitle;
                        
                        // Add hover effect and preloading
                        span.addEventListener('mouseenter', () => {
                            span.style.textDecoration = 'underline';
                            setTimeout(() => {
                                if (span.matches(':hover')) {
                                    preloadArticle(articleTitle);
                                }
                            }, 200);
                        });
                        span.addEventListener('mouseleave', () => {
                            span.style.textDecoration = 'none';
                        });
                        
                        // Add click handler
                        span.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            
                            console.log('Iframe link clicked:', articleTitle);
                            
                            if (articleTitle && articleTitle.trim() !== '') {
                                fetchWikipediaArticle(articleTitle);
                            }
                        });
                        
                        // Replace the original link
                        link.parentNode.replaceChild(span, link);
                    } else {
                        // For non-Wikipedia links, disable them
                        console.log('Non-Wikipedia link, disabling:', link.textContent);
                        link.style.cssText = 'color: #666; cursor: default;';
                        link.title = 'External link disabled';
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                        });
                    }
                });
            };
        }
        
        // Global click handler for wiki links using event delegation
        document.addEventListener('click', function(e) {
            const target = e.target.closest('.wiki-link');
            if (target && target.dataset.articleTitle) {
                e.preventDefault();
                e.stopPropagation();
                
                const articleTitle = target.dataset.articleTitle;
                console.log('Global click handler - Wiki link clicked:', articleTitle);
                console.log('Navigation from:', currentArticle, 'to:', articleTitle);
                
                if (articleTitle && articleTitle.trim() !== '') {
                    fetchWikipediaArticle(articleTitle);
                }
            }
        });
        
        // Load a random article on page load
        async function loadRandomArticle() {
            try {
                const response = await fetch('https://en.wikipedia.org/api/rest_v1/page/random/summary');
                const data = await response.json();
                const title = data.title;
                
                console.log('Loading random article:', title);
                fetchWikipediaArticle(title);
            } catch (error) {
                console.error('Error loading random article:', error);
                // Fallback to a known article
                fetchWikipediaArticle('Wikipedia');
            }
        }
        
        // Start with a new game
        initializeCache(); // Initialize cache before starting the game
        initializeGame();
    </script>
</body>
</html>